// AIæ–‡å­—å¤„ç†
// é…ç½®DeepSeek API
const DEEPSEEK_CONFIG = {
    API_URL: 'https://api.deepseek.com/v1/chat/completions',
    CHAT_MODEL: 'deepseek-chat',
    REASONER_MODEL: 'deepseek-reasoner'
};

// è¯­è¨€ä»£ç æ˜ å°„ - ä¿®å¤äº†ç›®æ ‡è¯­è¨€é€»è¾‘
const LANGUAGE_MAP = {
    'en': { 
        name: 'è‹±è¯­', 
        flag: 'ğŸ‡ºğŸ‡¸', 
        target: 'zh',  // è‹±è¯­çš„ç›®æ ‡è¯­è¨€æ˜¯ä¸­æ–‡
        targetName: 'ä¸­æ–‡',
        targetFlag: 'ğŸ‡¨ğŸ‡³'
    },
    'zh': { 
        name: 'ä¸­æ–‡', 
        flag: 'ğŸ‡¨ğŸ‡³', 
        target: 'en',  // ä¸­æ–‡çš„ç›®æ ‡è¯­è¨€æ˜¯è‹±è¯­
        targetName: 'è‹±è¯­',
        targetFlag: 'ğŸ‡ºğŸ‡¸'
    },
    'ja': { 
        name: 'æ—¥è¯­', 
        flag: 'ğŸ‡¯ğŸ‡µ', 
        target: 'zh',
        targetName: 'ä¸­æ–‡',
        targetFlag: 'ğŸ‡¨ğŸ‡³'
    },
    'ko': { 
        name: 'éŸ©è¯­', 
        flag: 'ğŸ‡°ğŸ‡·', 
        target: 'zh',
        targetName: 'ä¸­æ–‡',
        targetFlag: 'ğŸ‡¨ğŸ‡³'
    },
    'fr': { 
        name: 'æ³•è¯­', 
        flag: 'ğŸ‡«ğŸ‡·', 
        target: 'zh',
        targetName: 'ä¸­æ–‡',
        targetFlag: 'ğŸ‡¨ğŸ‡³'
    },
    'de': { 
        name: 'å¾·è¯­', 
        flag: 'ğŸ‡©ğŸ‡ª', 
        target: 'zh',
        targetName: 'ä¸­æ–‡',
        targetFlag: 'ğŸ‡¨ğŸ‡³'
    },
    'es': { 
        name: 'è¥¿ç­ç‰™è¯­', 
        flag: 'ğŸ‡ªğŸ‡¸', 
        target: 'zh',
        targetName: 'ä¸­æ–‡',
        targetFlag: 'ğŸ‡¨ğŸ‡³'
    },
    'ru': { 
        name: 'ä¿„è¯­', 
        flag: 'ğŸ‡·ğŸ‡º', 
        target: 'zh',
        targetName: 'ä¸­æ–‡',
        targetFlag: 'ğŸ‡¨ğŸ‡³'
    }
};

// é»˜è®¤è¯­è¨€æ£€æµ‹
const DEFAULT_LANGUAGE = 'en';

// DOMå…ƒç´ 
const inputText = document.getElementById('input-text');
const outputDisplay = document.getElementById('output-display');
const translateBtn = document.getElementById('translate-btn');
const paraphraseBtn = document.getElementById('paraphrase-btn');
const clearBtn = document.getElementById('clear-btn');
const apiKeyInput = document.getElementById('api-key-input');
const apiStatus = document.getElementById('api-status');
const loading = document.getElementById('loading');
const loadingText = document.getElementById('loading-text');
const errorMessage = document.getElementById('error-message');
const successMessage = document.getElementById('success-message');
const inputLangText = document.getElementById('input-lang-text');
const outputLangText = document.getElementById('output-lang-text');

// å­˜å‚¨å’Œè·å–APIå¯†é’¥
function saveApiKey(apiKey) {
    if (apiKey && apiKey.trim() !== '') {
        sessionStorage.setItem('deepseek_api_key', apiKey.trim());
        updateApiStatus(true);
    } else {
        sessionStorage.removeItem('deepseek_api_key');
        updateApiStatus(false);
    }
}

function getApiKey() {
    return sessionStorage.getItem('deepseek_api_key');
}

function updateApiStatus(isValid) {
    if (isValid) {
        apiStatus.textContent = 'å·²è®¾ç½®';
        apiStatus.className = 'api-status api-valid';
    } else {
        apiStatus.textContent = 'æœªè®¾ç½®';
        apiStatus.className = 'api-status api-invalid';
    }
}

// è‡ªåŠ¨è¯­è¨€æ£€æµ‹å‡½æ•° - ç§»é™¤äº†francä¾èµ–
function detectLanguage(text) {
    if (!text || text.trim().length < 2) {
        return DEFAULT_LANGUAGE;
    }

    try {
        // åŸºäºå­—ç¬¦çš„ç®€å•å¯å‘å¼æ£€æµ‹
        const chineseCharCount = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
        const totalChars = text.length;
        
        // å¦‚æœä¸­æ–‡å­—ç¬¦æ•°è¶…è¿‡æ€»å­—ç¬¦æ•°çš„30%ï¼Œåˆ™è®¤ä¸ºæ˜¯ä¸­æ–‡
        if (chineseCharCount > totalChars * 0.3) {
            return 'zh';
        } else {
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å¸¸è§è‹±æ–‡å­—ç¬¦
            const englishCharCount = (text.match(/[a-zA-Z]/g) || []).length;
            if (englishCharCount > totalChars * 0.5) {
                return 'en';
            } else {
                // å¦‚æœæ—¢ä¸æ˜¯æ˜æ˜¾çš„ä¸­æ–‡ä¹Ÿä¸æ˜¯æ˜æ˜¾çš„è‹±æ–‡ï¼Œé»˜è®¤è‹±æ–‡
                return 'en';
            }
        }
    } catch (error) {
        console.error('è¯­è¨€æ£€æµ‹é”™è¯¯:', error);
        // é»˜è®¤è‹±æ–‡
        return 'en';
    }
}

// æ›´æ–°è¯­è¨€æ˜¾ç¤º - ä¿®å¤äº†ç›®æ ‡è¯­è¨€æ˜¾ç¤ºé€»è¾‘
function updateLanguageDisplay(sourceLangCode, isParaphrase = false) {
    const sourceLangInfo = LANGUAGE_MAP[sourceLangCode] || LANGUAGE_MAP[DEFAULT_LANGUAGE];
    
    // æ›´æ–°è¾“å…¥è¯­è¨€æ˜¾ç¤º
    inputLangText.textContent = `æ£€æµ‹åˆ°: ${sourceLangInfo.flag} ${sourceLangInfo.name}`;
    
    if (isParaphrase) {
        // è½¬è¿°åŠŸèƒ½ä¿æŒç›¸åŒè¯­è¨€
        outputLangText.textContent = `è½¬è¿°ä¸º: ${sourceLangInfo.flag} ${sourceLangInfo.name}`;
    } else {
        // ç¿»è¯‘åŠŸèƒ½æ”¹å˜è¯­è¨€
        const targetLangCode = sourceLangInfo.target;
        const targetLangInfo = LANGUAGE_MAP[targetLangCode] || LANGUAGE_MAP['zh'];
        outputLangText.textContent = `ç¿»è¯‘ä¸º: ${targetLangInfo.flag} ${targetLangInfo.name}`;
    }
}

// ç¿»è¯‘å‡½æ•° - ä»ç„¶ä½¿ç”¨deepseek-chat
async function translateText() {
    const text = inputText.value.trim();
    
    // è¾“å…¥éªŒè¯
    if (!text) {
        showError('è¯·è¾“å…¥è¦ç¿»è¯‘çš„æ–‡æœ¬');
        return;
    }

    // æ£€æŸ¥APIå¯†é’¥
    const apiKey = getApiKey();
    if (!apiKey) {
        showError('è¯·å…ˆè¾“å…¥æ‚¨çš„DeepSeek APIå¯†é’¥');
        apiKeyInput.focus();
        return;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    showLoading('æ­£åœ¨æ£€æµ‹è¯­è¨€å¹¶ç¿»è¯‘ï¼Œè¯·ç¨å€™...');
    hideError();
    hideSuccess();

    try {
        // æ£€æµ‹è¾“å…¥è¯­è¨€
        const sourceLang = detectLanguage(text);
        updateLanguageDisplay(sourceLang, false);
        
        // ç¡®å®šç›®æ ‡è¯­è¨€
        const targetLang = LANGUAGE_MAP[sourceLang].target;
        const sourceLangName = LANGUAGE_MAP[sourceLang].name;
        const targetLangName = LANGUAGE_MAP[targetLang].name;
        
        // æ ¹æ®è¯­è¨€æ–¹å‘æ„å»ºç¿»è¯‘æŒ‡ä»¤
        let translationInstruction = '';
        if (sourceLang === 'zh' && targetLang === 'en') {
            translationInstruction = 'è¯·å°†ä»¥ä¸‹ä¸­æ–‡æ–‡æœ¬å‡†ç¡®ç¿»è¯‘æˆè‹±æ–‡ï¼š';
        } else if (sourceLang === 'en' && targetLang === 'zh') {
            translationInstruction = 'è¯·å°†ä»¥ä¸‹è‹±æ–‡æ–‡æœ¬å‡†ç¡®ç¿»è¯‘æˆä¸­æ–‡ï¼š';
        } else {
            translationInstruction = `è¯·å°†ä»¥ä¸‹${sourceLangName}æ–‡æœ¬å‡†ç¡®ç¿»è¯‘æˆ${targetLangName}ï¼š`;
        }

        // å‡†å¤‡è¯·æ±‚æ•°æ® - ä½¿ç”¨deepseek-chatæ¨¡å‹
        const requestData = {
            model: DEEPSEEK_CONFIG.CHAT_MODEL,
            messages: [
                {
                    role: "system",
                    content: "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç¿»è¯‘ä¸“å®¶ï¼Œè¯·å‡†ç¡®ç¿»è¯‘ç”¨æˆ·æä¾›çš„æ–‡æœ¬ï¼Œä¿æŒåŸæ–‡çš„æ„æ€å’Œé£æ ¼ï¼Œä¸è¦æ·»åŠ é¢å¤–ä¿¡æ¯ã€‚"
                },
                {
                    role: "user",
                    content: translationInstruction + "\n" + text
                }
            ],
            temperature: 0.3,
            max_tokens: 2000
        };

        // å‘é€APIè¯·æ±‚
        const response = await fetch(DEEPSEEK_CONFIG.API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + apiKey
            },
            body: JSON.stringify(requestData)
        });

        if (!response.ok) {
            throw new Error('APIè¯·æ±‚å¤±è´¥: ' + response.status + ' ' + response.statusText);
        }

        const data = await response.json();
        
        // å¤„ç†APIå“åº”
        if (data.choices && data.choices.length > 0) {
            const translatedText = data.choices[0].message.content;
            outputDisplay.textContent = translatedText;
            showSuccess('ç¿»è¯‘å®Œæˆï¼');
        } else {
            throw new Error('APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
        }

    } catch (error) {
        console.error('ç¿»è¯‘é”™è¯¯:', error);
        showError('ç¿»è¯‘å¤±è´¥: ' + error.message);
    } finally {
        hideLoading();
    }
}

// è½¬è¿°å‡½æ•° - æ”¹ä¸ºä½¿ç”¨deepseek-reasoner
async function paraphraseText() {
    const text = inputText.value.trim();
    
    // è¾“å…¥éªŒè¯
    if (!text) {
        showError('è¯·è¾“å…¥è¦è½¬è¿°çš„æ–‡æœ¬');
        return;
    }

    // æ£€æŸ¥APIå¯†é’¥
    const apiKey = getApiKey();
    if (!apiKey) {
        showError('è¯·å…ˆè¾“å…¥æ‚¨çš„DeepSeek APIå¯†é’¥');
        apiKeyInput.focus();
        return;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    showLoading('æ­£åœ¨ä½¿ç”¨æ·±åº¦æ¨ç†æ¨¡å‹è½¬è¿°æ–‡æœ¬ï¼Œè¯·ç¨å€™...');
    hideError();
    hideSuccess();

    try {
        // æ£€æµ‹è¾“å…¥è¯­è¨€
        const sourceLang = detectLanguage(text);
        updateLanguageDisplay(sourceLang, true);
        
        // æ ¹æ®è¯­è¨€æ„å»ºè½¬è¿°æŒ‡ä»¤
        const sourceLangName = LANGUAGE_MAP[sourceLang].name;
        
        // è½¬è¿°æŒ‡ä»¤ - å¼ºè°ƒä¿ç•™ä¸“æœ‰åè¯å’Œä¸“ä¸šæœ¯è¯­
        let paraphraseInstruction = '';
        if (sourceLang === 'zh') {
            paraphraseInstruction = `è¯·å¯¹ä»¥ä¸‹ä¸­æ–‡æ–‡æœ¬è¿›è¡Œå­¦æœ¯è½¬è¿°ï¼Œè¦æ±‚ï¼š
1. ä¿ç•™æ‰€æœ‰ä¸“æœ‰åè¯ã€äººåã€åœ°åã€æœºæ„åå’Œä¸“ä¸šå­¦æœ¯æœ¯è¯­
2. æ”¹å˜å¥å¼ç»“æ„å’Œç”¨è¯ï¼Œé™ä½ä¸åŸæ–‡çš„é‡å¤ç‡
3. ä¿æŒå­¦æœ¯ä¸¥è°¨æ€§å’ŒåŸæ–‡çš„æ ¸å¿ƒå«ä¹‰
4. è¾“å‡ºè¯­è¨€ä¿æŒä¸ºä¸­æ–‡

è¯·é€æ­¥æ€è€ƒå¹¶åˆ†æåŸæ–‡ï¼Œç„¶åç»™å‡ºè½¬è¿°ç»“æœã€‚

éœ€è¦è½¬è¿°çš„æ–‡æœ¬ï¼š`;
        } else {
            paraphraseInstruction = `Please paraphrase the following English text for academic purposes, with these requirements:
1. Preserve all proper nouns, names, places, organizations, and specialized academic terminology
2. Change sentence structures and word choices to reduce similarity with the original text
3. Maintain academic rigor and the core meaning of the original
4. Keep the output in English

Please think step by step and analyze the original text before providing the paraphrased version.

Text to paraphrase:`;
        }

        // å‡†å¤‡è¯·æ±‚æ•°æ® - ä½¿ç”¨deepseek-reasoneræ¨¡å‹
        const requestData = {
            model: DEEPSEEK_CONFIG.REASONER_MODEL,
            messages: [
                {
                    role: "system",
                    content: "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å­¦æœ¯å†™ä½œåŠ©æ‰‹ï¼Œæ“…é•¿æ–‡æœ¬è½¬è¿°ï¼Œèƒ½å¤Ÿä¿ç•™ä¸“ä¸šæœ¯è¯­åŒæ—¶æ”¹å˜è¡¨è¾¾æ–¹å¼ã€‚è¯·ä½¿ç”¨é€æ­¥æ¨ç†æ¥åˆ†ææ–‡æœ¬ç»“æ„ï¼Œç„¶åç»™å‡ºé«˜è´¨é‡çš„è½¬è¿°ç»“æœã€‚"
                },
                {
                    role: "user",
                    content: paraphraseInstruction + "\n" + text
                }
            ],
            temperature: 0.7, // è½¬è¿°éœ€è¦æ›´é«˜çš„åˆ›é€ æ€§
            max_tokens: 4000  // å¢åŠ tokené™åˆ¶ä»¥å®¹çº³æ¨ç†è¿‡ç¨‹
        };

        // å‘é€APIè¯·æ±‚
        const response = await fetch(DEEPSEEK_CONFIG.API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + apiKey
            },
            body: JSON.stringify(requestData)
        });

        if (!response.ok) {
            throw new Error('APIè¯·æ±‚å¤±è´¥: ' + response.status + ' ' + response.statusText);
        }

        const data = await response.json();
        
        // å¤„ç†APIå“åº”
        if (data.choices && data.choices.length > 0) {
            const paraphrasedText = data.choices[0].message.content;
            outputDisplay.textContent = paraphrasedText;
            showSuccess('å­¦æœ¯è½¬è¿°å®Œæˆï¼(ä½¿ç”¨æ·±åº¦æ¨ç†æ¨¡å‹)');
        } else {
            throw new Error('APIè¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
        }

    } catch (error) {
        console.error('è½¬è¿°é”™è¯¯:', error);
        showError('è½¬è¿°å¤±è´¥: ' + error.message);
    } finally {
        hideLoading();
    }
}

// å®æ—¶è¯­è¨€æ£€æµ‹ï¼ˆé˜²æŠ–å¤„ç†ï¼‰
let detectTimeout;
function handleInputChange() {
    clearTimeout(detectTimeout);
    const text = inputText.value.trim();
    
    if (text.length > 1) {
        detectTimeout = setTimeout(() => {
            const detectedLang = detectLanguage(text);
            updateLanguageDisplay(detectedLang, false);
        }, 500);
    } else {
        inputLangText.textContent = 'ç­‰å¾…æ£€æµ‹è¾“å…¥è¯­è¨€...';
        outputLangText.textContent = 'ç­‰å¾…å¤„ç†ç»“æœ...';
    }
}

// æ¸…ç©ºè¾“å…¥å’Œè¾“å‡º
function clearAll() {
    inputText.value = '';
    outputDisplay.textContent = 'å¤„ç†ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...';
    inputLangText.textContent = 'ç­‰å¾…æ£€æµ‹è¾“å…¥è¯­è¨€...';
    outputLangText.textContent = 'ç­‰å¾…å¤„ç†ç»“æœ...';
    hideError();
    hideSuccess();
}

// UIçŠ¶æ€æ§åˆ¶å‡½æ•°
function showLoading(message = 'æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...') {
    loadingText.textContent = message;
    loading.style.display = 'block';
    translateBtn.disabled = true;
    paraphraseBtn.disabled = true;
    translateBtn.textContent = 'å¤„ç†ä¸­...';
    paraphraseBtn.textContent = 'å¤„ç†ä¸­...';
}

function hideLoading() {
    loading.style.display = 'none';
    translateBtn.disabled = false;
    paraphraseBtn.disabled = false;
    translateBtn.textContent = 'è‡ªåŠ¨ç¿»è¯‘';
    paraphraseBtn.textContent = 'å­¦æœ¯è½¬è¿°';
}

function showError(message) {
    errorMessage.textContent = message;
    errorMessage.style.display = 'block';
}

function hideError() {
    errorMessage.style.display = 'none';
}

function showSuccess(message) {
    successMessage.textContent = message;
    successMessage.style.display = 'block';
    setTimeout(hideSuccess, 3000);
}

function hideSuccess() {
    successMessage.style.display = 'none';
}

// äº‹ä»¶ç›‘å¬
translateBtn.addEventListener('click', translateText);
paraphraseBtn.addEventListener('click', paraphraseText);
clearBtn.addEventListener('click', clearAll);
inputText.addEventListener('input', handleInputChange);

// APIå¯†é’¥è¾“å…¥äº‹ä»¶
apiKeyInput.addEventListener('input', function() {
    saveApiKey(this.value);
});

// å¿«æ·é”®å¤„ç†
inputText.addEventListener('keydown', function(e) {
    // Ctrl+Enter ç¿»è¯‘
    if (e.ctrlKey && e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        translateText();
    }
    // Ctrl+Shift+Enter è½¬è¿°
    else if (e.ctrlKey && e.shiftKey && e.key === 'Enter') {
        e.preventDefault();
        paraphraseText();
    }
});

// é¡µé¢åŠ è½½å®Œæˆå
window.addEventListener('load', function() {
    // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜çš„APIå¯†é’¥
    const savedApiKey = getApiKey();
    if (savedApiKey) {
        apiKeyInput.value = savedApiKey;
        updateApiStatus(true);
        // æœ‰å¯†é’¥æ—¶ï¼Œå…‰æ ‡å®šä½åˆ°è¾“å…¥æ¡†
        inputText.focus();
    } else {
        // æ²¡æœ‰å¯†é’¥æ—¶ï¼Œå…‰æ ‡å®šä½åˆ°APIå¯†é’¥è¾“å…¥æ¡†
        apiKeyInput.focus();
    }
});