<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI文字处理</title>
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <link rel="stylesheet" href="../style sheet.css">
    <style>
        *, *::before, *::after {
        box-sizing: border-box;
        user-select: text;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="">
        <div class="logo">
            <img src="../Icon/Logo2.jpg" width="60px" alt="玟喆生物">
            <ul>
                <li>WZ</li>
                <li>Biotech</li>
            </ul>
        </div>
    </a>
    <div class="title">
        AI文字处理
        <a href="./Knowledge catalogue.html"><img src="../Icon/Experiment.jpg" height="78px" alt="返回实验菜单"></a>
    </div>

    <div class="container">
        <div class="main-content">
            <div class="input-section">
                <h2>输入文本</h2>
                <textarea id="input-text" placeholder="请输入中文或英文文本，系统将自动识别并翻译..."></textarea>
                <div id="input-language" class="language-info">
                    <span class="language-flag">🌐</span>
                    <span id="input-lang-text">等待检测输入语言...</span>
                </div>
                <div class="controls">
                    <div class="button-group">
                        <button id="translate-btn">自动翻译</button>
                        <button id="paraphrase-btn">学术转述</button>
                        <button id="clear-btn">清空</button>
                    </div>
                </div>
                <div class="shortcut-hint">提示: 按 Ctrl+Enter 快速翻译，Ctrl+Shift+Enter 快速转述</div>
            </div>

            <div class="output-section">
                <h2>处理结果</h2>
                <div id="output-display" class="output-display">
                    处理结果将显示在这里...
                </div>
                <div id="output-language" class="language-info">
                    <span class="language-flag">🌐</span>
                    <span id="output-lang-text">等待处理结果...</span>
                </div>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p id="loading-text">正在处理，请稍候...</p>
        </div>

        <div id="error-message" class="error"></div>
        <div id="success-message" class="success"></div>

        <footer>
            Powered by DeepSeek | Response is AI-generated, for reference only<br>
            如有疑问请发送邮件至<a href="mailto:service@wzbiotech.cn">service@wzbiotech.cn</a><br>
            &copy;上海玟喆生物科技有限公司 <br>
            地址：上海市青浦区公园路348号7层
        </footer>
    </div>

    <script>
        // AI文字处理 - 最终版本（已修复参数传递问题）
        const CLOUD_FUNCTION_CONFIG = {
            HTTP_URL: 'https://fc-mp-cebc99d5-4fe8-4142-8c86-23b8f6dc1e7c.next.bspapp.com/deepseek-api'
        };

        // 语言代码映射
        const LANGUAGE_MAP = {
            'en': { 
                name: '英语', 
                flag: '🇺🇸', 
                target: 'zh',
                targetName: '中文',
                targetFlag: '🇨🇳'
            },
            'zh': { 
                name: '中文', 
                flag: '🇨🇳', 
                target: 'en',
                targetName: '英语',
                targetFlag: '🇺🇸'
            },
            'ja': { 
                name: '日语', 
                flag: '🇯🇵', 
                target: 'zh',
                targetName: '中文',
                targetFlag: '🇨🇳'
            },
            'ko': { 
                name: '韩语', 
                flag: '🇰🇷', 
                target: 'zh',
                targetName: '中文',
                targetFlag: '🇨🇳'
            },
            'fr': { 
                name: '法语', 
                flag: '🇫🇷', 
                target: 'zh',
                targetName: '中文',
                targetFlag: '🇨🇳'
            },
            'de': { 
                name: '德语', 
                flag: '🇩🇪', 
                target: 'zh',
                targetName: '中文',
                targetFlag: '🇨🇳'
            },
            'es': { 
                name: '西班牙语', 
                flag: '🇪🇸', 
                target: 'zh',
                targetName: '中文',
                targetFlag: '🇨🇳'
            },
            'ru': { 
                name: '俄语', 
                flag: '🇷🇺', 
                target: 'zh',
                targetName: '中文',
                targetFlag: '🇨🇳'
            }
        };

        // DOM元素
        const inputText = document.getElementById('input-text');
        const outputDisplay = document.getElementById('output-display');
        const translateBtn = document.getElementById('translate-btn');
        const paraphraseBtn = document.getElementById('paraphrase-btn');
        const clearBtn = document.getElementById('clear-btn');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        const inputLangText = document.getElementById('input-lang-text');
        const outputLangText = document.getElementById('output-lang-text');

        // 自动语言检测函数
        function detectLanguage(text) {
            if (!text || text.trim().length < 2) return 'en';
            
            try {
                const chineseCharCount = (text.match(/[\u4e00-\u9fa5]/g) || []).length;
                const totalChars = text.length;
                return chineseCharCount > totalChars * 0.3 ? 'zh' : 'en';
            } catch (error) {
                console.error('语言检测错误:', error);
                return 'en';
            }
        }

        // 更新语言显示
        function updateLanguageDisplay(sourceLangCode, isParaphrase = false) {
            const sourceLangInfo = LANGUAGE_MAP[sourceLangCode] || LANGUAGE_MAP['en'];
            inputLangText.textContent = `检测到: ${sourceLangInfo.flag} ${sourceLangInfo.name}`;
            
            if (isParaphrase) {
                outputLangText.textContent = `转述为: ${sourceLangInfo.flag} ${sourceLangInfo.name}`;
            } else {
                const targetLangCode = sourceLangInfo.target;
                const targetLangInfo = LANGUAGE_MAP[targetLangCode] || LANGUAGE_MAP['zh'];
                outputLangText.textContent = `翻译为: ${targetLangInfo.flag} ${targetLangInfo.name}`;
            }
        }

        // 调用云函数 - 修复版
        async function callCloudFunction(text, action, sourceLang, targetLang) {
            if (!CLOUD_FUNCTION_CONFIG.HTTP_URL) {
                throw new Error('云函数URL未配置');
            }

            console.log('调用云函数:', { text, action, sourceLang, targetLang });
            
            try {
                // 构建与EMAS调试器相同的请求格式
                const requestBody = {
                    text: text,
                    action: action,
                    sourceLang: sourceLang,
                    targetLang: targetLang
                };

                console.log('发送的请求体:', JSON.stringify(requestBody, null, 2));
                
                const response = await fetch(CLOUD_FUNCTION_CONFIG.HTTP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP请求失败: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('云函数返回原始数据:', data);
                
                // 直接返回data，因为云函数已经返回了完整的响应结构
                return data;

            } catch (error) {
                console.error('调用云函数异常:', error);
                throw error;
            }
        }

        // 翻译函数
        async function translateText() {
            const text = inputText.value.trim();
            if (!text) {
                showError('请输入要翻译的文本');
                return;
            }

            showLoading('正在检测语言并翻译，请稍候...');
            hideError();
            hideSuccess();

            try {
                const sourceLang = detectLanguage(text);
                updateLanguageDisplay(sourceLang, false);
                const targetLang = LANGUAGE_MAP[sourceLang].target;
                
                const result = await callCloudFunction(text, 'translate', sourceLang, targetLang);
                
                // 处理云函数返回的格式
                if (result.body) {
                    // 如果返回了body字段，需要解析
                    let bodyData;
                    if (typeof result.body === 'string') {
                        bodyData = JSON.parse(result.body);
                    } else {
                        bodyData = result.body;
                    }
                    
                    if (bodyData && bodyData.result) {
                        outputDisplay.textContent = bodyData.result;
                        showSuccess('翻译完成！');
                    } else {
                        throw new Error('返回结果格式错误: ' + JSON.stringify(result));
                    }
                } else if (result.result) {
                    // 如果直接返回了result字段
                    outputDisplay.textContent = result.result;
                    showSuccess('翻译完成！');
                } else {
                    throw new Error('返回结果格式错误: ' + JSON.stringify(result));
                }

            } catch (error) {
                console.error('翻译错误:', error);
                showError('翻译失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 转述函数
        async function paraphraseText() {
            const text = inputText.value.trim();
            if (!text) {
                showError('请输入要转述的文本');
                return;
            }

            showLoading('正在使用深度推理模型转述文本，请稍候...');
            hideError();
            hideSuccess();

            try {
                const sourceLang = detectLanguage(text);
                updateLanguageDisplay(sourceLang, true);
                
                const result = await callCloudFunction(text, 'paraphrase', sourceLang, sourceLang);
                
                // 处理云函数返回的格式
                if (result.body) {
                    let bodyData;
                    if (typeof result.body === 'string') {
                        bodyData = JSON.parse(result.body);
                    } else {
                        bodyData = result.body;
                    }
                    
                    if (bodyData && bodyData.result) {
                        outputDisplay.textContent = bodyData.result;
                        showSuccess('学术转述完成！(使用深度推理模型)');
                    } else {
                        throw new Error('返回结果格式错误: ' + JSON.stringify(result));
                    }
                } else if (result.result) {
                    outputDisplay.textContent = result.result;
                    showSuccess('学术转述完成！(使用深度推理模型)');
                } else {
                    throw new Error('返回结果格式错误: ' + JSON.stringify(result));
                }

            } catch (error) {
                console.error('转述错误:', error);
                showError('转述失败: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // UI控制函数
        function showLoading(message = '正在处理，请稍候...') {
            loadingText.textContent = message;
            loading.style.display = 'block';
            translateBtn.disabled = true;
            paraphraseBtn.disabled = true;
        }

        function hideLoading() {
            loading.style.display = 'none';
            translateBtn.disabled = false;
            paraphraseBtn.disabled = false;
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            setTimeout(hideSuccess, 3000);
        }

        function hideSuccess() {
            successMessage.style.display = 'none';
        }

        // 事件监听
        translateBtn.addEventListener('click', translateText);
        paraphraseBtn.addEventListener('click', paraphraseText);
        clearBtn.addEventListener('click', function() {
            inputText.value = '';
            outputDisplay.textContent = '处理结果将显示在这里...';
            inputLangText.textContent = '等待检测输入语言...';
            outputLangText.textContent = '等待处理结果...';
            hideError();
            hideSuccess();
        });

        // 实时语言检测（防抖处理）
        let detectTimeout;
        function handleInputChange() {
            clearTimeout(detectTimeout);
            const text = inputText.value.trim();
            
            if (text.length > 1) {
                detectTimeout = setTimeout(() => {
                    const detectedLang = detectLanguage(text);
                    updateLanguageDisplay(detectedLang, false);
                }, 500);
            } else {
                inputLangText.textContent = '等待检测输入语言...';
                outputLangText.textContent = '等待处理结果...';
            }
        }

        inputText.addEventListener('input', handleInputChange);

        // 快捷键处理
        inputText.addEventListener('keydown', function(e) {
            // Ctrl+Enter 翻译
            if (e.ctrlKey && e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                translateText();
            }
            // Ctrl+Shift+Enter 转述
            else if (e.ctrlKey && e.shiftKey && e.key === 'Enter') {
                e.preventDefault();
                paraphraseText();
            }
        });

        // 页面加载完成后
        window.addEventListener('load', function() {
            // 光标定位到输入框
            inputText.focus();
            
            console.log('AI文字处理系统已加载，云函数URL:', CLOUD_FUNCTION_CONFIG.HTTP_URL);
        });
    </script>
</body>
</html>